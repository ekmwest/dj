<html>

<head>
    <meta charset="UTF-8">
    <title>DJ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex" />
    <link rel="shortcut icon" type="image/png" href="/wheel.png" />
    <link rel="apple-touch-icon" href="/wheel.png">
    <script src="/log.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script>

        /* =====================================================================
           Constants
           ===================================================================== */

        const RATE_LIMIT = 15000 / 365;
        const PERIOD_END = "2023-07-08";


        /* =====================================================================
           Import Log
           ===================================================================== */

        const log = expandLog(LOG, RATE_LIMIT);


        /* =====================================================================
           Run
           ===================================================================== */

        google.charts.load('current', { packages: ['corechart', 'line'] });
        google.charts.setOnLoadCallback(() => drawChart(log));

        document.addEventListener('DOMContentLoaded', () => {
            drawCredit(log, RATE_LIMIT);
            drawPeriodCredit(log, RATE_LIMIT);
        });


        /* =====================================================================
           Functions
           ===================================================================== */

        function createDate(dateString) {
            const d = dateString ? new Date(dateString) : new Date();
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function expandLog(log, rateLimit) {
            const startMeter = log[0][1];
            const startDate = createDate(log[0][0]);

            const expanded = log.map(item => {
                const date = createDate(item[0]);
                const distance = Math.round(item[1] - startMeter);
                const distanceLimit = Math.round((date - startDate) / (24 * 60 * 60 * 1000) * rateLimit);

                return [date, distance, distanceLimit];
            });

            // Create virtual item for today (unless last item is, in fact, today)
            const today = createDate();
            const lastLogItem = expanded.slice(-1)[0];
            const lastLogDate = lastLogItem[0];

            if (today > lastLogDate) {
                const distance = Math.round(lastLogItem[1]);
                const distanceLimit = Math.round((today - startDate) / (24 * 60 * 60 * 1000) * rateLimit);

                expanded.push([today, distance, distanceLimit])
            }
            return expanded;
        }

        function drawChart() {

            var data = new google.visualization.DataTable();
            data.addColumn('date', 'Date');
            data.addColumn('number', 'Log');
            data.addColumn('number', 'Limit');

            data.addRows(log)

            var options = {
                hAxis: {
                    title: ''
                },
                vAxis: {
                    title: ''
                },
                colors: ['#999', 'red'],
                legend: 'none',
                chartArea: { 'width': '85%', 'height': '85%' }
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart'));

            chart.draw(data, options);
        }

        function drawCredit(log, rateLimit) {
            const lastLogItem = log.slice(-1)[0];
            const distanceCredit = lastLogItem[2] - lastLogItem[1];
            const timeCredit = distanceCredit / rateLimit;

            if (distanceCredit < 0) {
                const creditElement = document.querySelector('#credit');
                creditElement.classList.add('NEGATIVE');
            }

            const distanceCreditElement = document.querySelector('#distance-credit');
            distanceCreditElement.textContent = Math.round(distanceCredit / 10) + ' mil';

            const timeCreditElement = document.querySelector('#time-credit');
            timeCreditElement.textContent = Math.round(timeCredit) + ' dgr';

        }

        function drawPeriodCredit(log, rateLimit) {

            const periodStartDate = log[0][0];
            const periodEndDate = createDate(PERIOD_END);
            const periodAvailable = Math.round((periodEndDate - periodStartDate) / (24 * 60 * 60 * 1000) * rateLimit);

            const currentDate = createDate();
            const currentUsed = log.slice(-1)[0][1];

            const remainingDays = Math.round((periodEndDate - currentDate) / (24 * 60 * 60 * 1000));
            const remainingDistance = Math.round(periodAvailable - currentUsed);
            const remainingRate = Math.round(remainingDistance / remainingDays);

            const periodDistanceCreditElement = document.querySelector('#period-distance-credit');
            periodDistanceCreditElement.textContent = Math.round(remainingDistance / 10) + " mil";

            const periodTimeCreditElement = document.querySelector('#period-time-credit');
            periodTimeCreditElement.textContent = remainingDays + " dgr";

            const periodRateCreditElement = document.querySelector('#period-rate-credit');
            periodRateCreditElement.textContent = (remainingRate / 10).toPrecision(2) + " mil/dag";
        }
    </script>

    <style>
        body {
            font-family: -apple-system, "Segoe UI", Helvetica, sans-serif;
        }

        main {
            max-width: 1024px;
            margin: 0 auto;
        }

        #credit,
        #period-credit {
            display: flex;
            justify-content: center;
            margin-top: 2em;
        }

        #credit-content,
        #period-credit-content {
            padding: 1em 1.8em;
            border-radius: .6em;
            font-weight: bold;
            color: green;
            border: 2px solid green;
            background-color: rgba(0, 255, 0, .04);
        }

        #credit.NEGATIVE #credit-content {
            color: red;
            border-color: red;
            background-color: rgba(255, 0, 0, .05);
        }

        #period-credit-content {
            color: #666;
            border-color: #888;
            background-color: rgba(0, 0, 0, .04);
        }

        #credit-space {
            padding: 0 .4em;
            position: relative;
            top: -2px;
        }

        #chart {
            height: 480px;
            margin-bottom: 3em;
        }

        #period-credit-divider {
            padding: 0 .3em;
            position: relative;
            top: -2px;
        }

        #bottom-space {
            height: 64px;
            padding: 1px 0;
        }
    </style>
</head>

<body>
    <main>
        <div id="credit">
            <div id="credit-content">
                <span id="distance-credit"></span>
                <span id="credit-space">|</span>
                <span id="time-credit"></span>
            </div>
        </div>

        <div id="chart"></div>

        <div id="period-credit">
            <div id="period-credit-content">
                <span id="period-distance-credit"></span>
                <span id="period-credit-divider">|</span>
                <span id="period-time-credit"></span>
                <span id="period-credit-divider">|</span>
                <span id="period-rate-credit"></span>
            </div>
        </div>

        <div id="bottom-space"></div>
    </main>
</body>

</html>